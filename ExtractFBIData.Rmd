---
title: "Property and violent crime rate change between 2009 and 2013"
output:
  pdf_document:
    fig_width: 7
    fig_height: 6
    fig_caption: true
    fig_crop: false

---

This analysis compares the property and violent crime rate changes in Los Angeles County by city utilizing data from the Federal Bureau of Investigation's (FBI) Uniform Crime Report (UCR). These data can be found in Table 8 @FBITable8 (2013) [here.](http://www.fbi.gov/about-us/cjis/ucr/ucr)  

In addition, inspiration for this report came from the 'Realignment, Incarceration, and Crime Trends in California
' by @PPICRealigmentTrends. This analysis shows that property crime rate have increased after AB 109 started. That report can be found [here.](http://www.ppic.org/main/publication_quick.asp?i=1151)   

For this analysis, the crime rates two years before and two years after the [AB-109 Criminal justice alignment](http://leginfo.legislature.ca.gov/faces/billNavClient.xhtml?bill_id=201120120AB109) @AB109 started were selected to determine crime rate changes.

```{r echo=FALSE, message=FALSE, include=FALSE}

rm(list=ls(all=TRUE)) #start with empty workspace
startTime <- Sys.time()

.libPaths("C:/Users/e551910/Desktop/rpackages")

doInstall <- FALSE # Change to TRUE if you do want packages installed.
toInstall <- c("knitr", "rvest", "NbClust", "cluster", "foreign", "dplyr", 
               "ggplot2", "scales", "RCurl", "RODBC", "xtable",
               "benford.analysis", "strucchange", "forecast", "tidyr")
if(doInstall){install.packages(toInstall, repos = "http://cran.us.r-project.org")}
lapply(toInstall, library, character.only = TRUE)

setwd("C:/Users/e551910/Desktop/AlhambraCityStatsJune18") # set the working directory
list.files() # see whats there

```

```{r echo=FALSE, include=FALSE}

# Download FBI Data

theurlPart1 <- "http://www.fbi.gov/about-us/cjis/ucr/crime-in-the-u.s/"

theurlPart213 <- "2013/crime-in-the-u.s.-2013/tables/table-8/table-8-state-cuts/"
theurlPart313 <- "table_8_offenses_known_to_law_enforcement_california_by_city_2013.xls"

theurlPart212 <- "2012/crime-in-the-u.s.-2012/tables/8tabledatadecpdf/"
theUrlPart213 <- "table-8-state-cuts/table_8_offenses_known_to_law_enforcement_by_california_by_city_2012.xls"

theurlPart211 <- "2011/crime-in-the-u.s.-2011/tables/table8statecuts/"
theUrlPart311 <- "table_8_offenses_known_to_law_enforcement_california_by_city_2011.xls"

theurlPart210 <- "2010/crime-in-the-u.s.-2010/tables/table-8/10tbl08ca.xls"

theurl2009 <- "http://www2.fbi.gov/ucr/cius2009/data/table_08_ca.html"

table8ColNames <- c("City","Population","Violent crime",
                           "Murder and nonnegligent manslaughter",
                           "Rape (legacy definition)2","Robbery",
                           "Aggravated assault","Property crime",
                           "Burglary","Larceny- theft","Motor vehicle theft",
                           "Arson")

# import the data for 2013
# tables <- readHTMLTable(paste0(theurlPart1,theurlPart213,theurlPart313))
# n.rows <- unlist(lapply(tables, function(t) dim(t)[1]))  # get the table with the highest number of rows

content2013 <- html(paste0(theurlPart1,theurlPart213,theurlPart313))%>%
    html_table(fill=TRUE)%>%
    .[[3]] # table 3 only

colnames(content2013) <- c("City","Population","Violent crime",
                           "Murder and nonnegligent manslaughter","Rape (revised definition)1",
                           "Rape (legacy definition)2","Robbery","Aggravated assault",
                           "Property crime","Burglary","Larceny- theft",
                           "Motor vehicle theft","Arson")

str(content2013); summary(content2013)

# add a variable to ID records

content2013$Type <- "CA2013"

str(content2013); summary(content2013)

# drop the col 'Rape (revised definition)1'

content2013 <- content2013[c(-5)]

# import the data for 2012

content2012 <- html(paste0(theurlPart1, theurlPart212, theUrlPart213))%>%
    html_table(fill=TRUE)%>%
    .[[3]] # table 3 only

# add column names

colnames(content2012) <- table8ColNames

# add a variable to ID records

content2012$Type <- "CA2012"

str(content2012); summary(content2012)

content2011 <- html(paste0(theurlPart1, theurlPart211, theUrlPart311))%>%
    html_table(fill=TRUE)%>%
    .[[3]] # table 3 only

# add column names

colnames(content2011) <- table8ColNames 

# add a variable to ID records

content2011$Type <- "CA2011"

str(content2011); summary(content2011)

content2010 <-  html(paste0(theurlPart1, theurlPart210))%>%
    html_table(fill=TRUE)%>%
    .[[3]] # table 3 only

# add column names

colnames(content2010) <- table8ColNames 

# add a variable to ID records

content2010$Type <- "CA2010"

str(content2010); summary(content2010)

content2009 <- html("http://www2.fbi.gov/ucr/cius2009/data/table_08_ca.html")%>%
    html_table(fill=TRUE)%>%
    .[[1]] # table 3 only

# add column names

colnames(content2009) <- table8ColNames

# add a variable to ID records

content2009$Type <- "CA2009"

str(content2009); summary(content2009)

# combine all the records

comboRecs <- rbind(content2009, content2010, content2011, content2012, content2013)

# make numeric colms

str(comboRecs)
    
comboRecs$Population <- as.numeric(gsub(",","", comboRecs$Population))
comboRecs$`Violent crime` <- as.numeric(gsub(",","", comboRecs$`Violent crime`))
comboRecs$`Murder and nonnegligent manslaughter` <- as.numeric(gsub(",","", comboRecs$`Murder and nonnegligent manslaughter`))
comboRecs$`Rape (legacy definition)2` <- as.numeric(gsub(",","", comboRecs$`Rape (legacy definition)2`))
comboRecs$Robbery <- as.numeric(gsub(",","", comboRecs$Robbery))
comboRecs$`Aggravated assault` <- as.numeric(gsub(",","", comboRecs$`Aggravated assault`))
comboRecs$`Property crime` <- as.numeric(gsub(",","", comboRecs$`Property crime`))
comboRecs$`Burglary` <- as.numeric(gsub(",","", comboRecs$`Burglary`))
comboRecs$`Larceny- theft` <- as.numeric(gsub(",","", comboRecs$`Larceny- theft`))
comboRecs$`Motor vehicle theft` <- as.numeric(gsub(",","", comboRecs$`Motor vehicle theft`))
comboRecs$Arson <- as.numeric(gsub(",","", comboRecs$Arson))

str(comboRecs)

# get the rates for each type of crime and violent and property crimes

comboRecs$ViolentCrimeRate <-  (comboRecs$`Violent crime`/comboRecs$Population)*100000
comboRecs$MurderAndNonnegligentManslaughterRate <-  (comboRecs$`Murder and nonnegligent manslaughter`/comboRecs$Population)*100000
comboRecs$RapeLegacyDefinitionRate <-  (comboRecs$`Rape (legacy definition)2`/comboRecs$Population)*100000
comboRecs$RobberyRate <-  (comboRecs$Robbery/comboRecs$Population)*100000
comboRecs$AggravatedAssaultRate <-  (comboRecs$`Aggravated assault`/comboRecs$Population)*100000
comboRecs$PropertyCrimeRate <-  (comboRecs$`Property crime`/comboRecs$Population)*100000
comboRecs$BurglaryRate <-  (comboRecs$Burglary/comboRecs$Population)*100000
comboRecs$LarcenyTheftRate <-  (comboRecs$`Larceny- theft`/comboRecs$Population)*100000
comboRecs$MotorVehicleTheftRate <-  (comboRecs$`Motor vehicle theft`/comboRecs$Population)*100000
comboRecs$ArsonRate <-  (comboRecs$Arson/comboRecs$Population)*100000

write.table(comboRecs, file = "./comboRecs.txt",  sep="\t", row.names = FALSE)

# get means by year

# get counts of records used for summarized data using fuction below
# fuction is from here
# http://www.cookbook-r.com/Manipulating_data/Summarizing_data/

length2 <- function (x, na.rm=FALSE) {
  if (na.rm) sum(!is.na(x))
  else       length(x)
  }

GroupedMeans <- comboRecs %>% 
  group_by(Type) %>% 
  summarise(ViolentCityYearAvgRate = mean(ViolentCrimeRate, na.rm = TRUE),
                                                           ViolentCityYearCount = length2(ViolentCrimeRate, na.rm = TRUE),
                                                           PropertyCityYearAvgRate = mean(PropertyCrimeRate, na.rm = TRUE),
                                                           PropertyCityYearCount = length2(PropertyCrimeRate, na.rm = TRUE))

```


```{r eval =FALSE, echo=FALSE}
# on the data for 2013 create a cluster analysis 

CA2013Data <- subset(comboRecs, 
                        Type == "CA2013",
                      select = c(City, MurderAndNonnegligentManslaughterRate, RapeLegacyDefinitionRate,
                                 RobberyRate, AggravatedAssaultRate, PropertyCrimeRate, BurglaryRate,
                                 LarcenyTheftRate, MotorVehicleTheftRate, ArsonRate))

ClusterData <- CA2013Data
rownames(ClusterData) <- ClusterData$City

ClusterData$City <- NULL

ClusterData <- scale(ClusterData)

# the fuction belwo is from here
# http://www.r-statistics.com/2013/08/k-means-clustering-from-r-in-action/

wssplot <- function(data, nc=15, seed=1234){
               wss <- (nrow(data)-1)*sum(apply(data,2,var))
               for (i in 2:nc){
                    set.seed(seed)
                    wss[i] <- sum(kmeans(data, centers=i)$withinss)}
                plot(1:nc, wss, type="b", xlab="Number of Clusters",
                     ylab="Within groups sum of squares")}

wssplot(ClusterData)

# do another cluster analysis

ClusterData <- scale(ClusterData)

gc() # do garbage collection

set.seed(1234)

nc <- NbClust(ClusterData, min.nc=2, max.nc=15, method="kmeans")

table(nc$Best.n[1,])

barplot(table(nc$Best.n[1,]),
          xlab="Numer of Clusters", ylab="Number of Criteria",
          main="Number of Clusters Chosen by Criteria")

set.seed(1234)

fit.km <- kmeans(ClusterData, 2, nstart=25)  # two clusters

fit.km$size

aggregate(CA2013Data[-1], by=list(cluster=fit.km$cluster), mean)

(ct.km <- table(CA2013Data$City, fit.km$cluster))

set.seed(1234)

(kmeans.result <- kmeans(ClusterData, 5))

# create a table with the clusters

table(CA2013Data$City, kmeans.result$cluster)

fit <- kmeans(ClusterData, 5)

clusplot(ClusterData, fit$cluster, color=TRUE, shade=TRUE, 
    labels=2, lines=0,  main="Simple Scatterplot Matrix")

clusterAll <- as.data.frame(table(CA2013Data$City, kmeans.result$cluster))

clusterAllList <- subset(clusterAll, Freq == 1)

# merge the cluster data with comboRecs

comboRecs <- merge(comboRecs, clusterAllList, by.x=c("City"),
    by.y=c("Var1"), all.x = TRUE)

```

```{r echo=FALSE, include=FALSE}
# Download Census data for commuters

x <- getURL("http://www.census.gov/hhes/commuting/files/ACS/Table3.csv")

CommuterAdjustedDaytimePopulation200620105yearACSCity <- read.csv(text = x)

str(CommuterAdjustedDaytimePopulation200620105yearACSCity)

# drop the first few rows

CommuterAdjustedDaytimePopulation200620105yearACSCity <- CommuterAdjustedDaytimePopulation200620105yearACSCity[-c(1:5), ]

head(CommuterAdjustedDaytimePopulation200620105yearACSCity)

# add col names

colnames(CommuterAdjustedDaytimePopulation200620105yearACSCity) <- 
  c("Summary level code","FIPS state code","FIPS place code","State name",
    "Place name","Total resident population Estimate","Total resident population MOE",
    "Total workers working in place Estimate","Total workers working in place MOE",
    "Total workers living in place Estimate","Total workers living in place MOE",
    "Estimated daytime population Estimate","Estimated daytime population MOE",
    "Daytime population change due to commuting Estimate",
    "Daytime population change due to commuting MOE",
    "Percent daytime population change due to commuting Estimate",
    "Percent daytime population change due to commuting MOE",
    "Workers who lived and worked in the same place Estimate",
    "Workers who lived and worked in the same place MOE",
    "Percent workers who lived and worked in the same place Estimate",
    "Percent workers who lived and worked in the same place MOE",
    "Employment residence ratio Estimate","Employment residence ratio MOE")

head(CommuterAdjustedDaytimePopulation200620105yearACSCity)

# clean up some names

trim <- function (x) gsub("^\\s+|\\s+$", "", x)
 
names(CommuterAdjustedDaytimePopulation200620105yearACSCity)
names(CommuterAdjustedDaytimePopulation200620105yearACSCity) <- 
  gsub("(\\w)(\\w*)", "\\U\\1\\L\\2", names(CommuterAdjustedDaytimePopulation200620105yearACSCity), perl = TRUE)

names(CommuterAdjustedDaytimePopulation200620105yearACSCity)  <- gsub(" ", "", names(CommuterAdjustedDaytimePopulation200620105yearACSCity))
names(CommuterAdjustedDaytimePopulation200620105yearACSCity)

# on the data there are two places named El Sobrante.  Need to recode them for the cluster analysis

CommuterAdjustedDaytimePopulation200620105yearACSCity$PlaceName <- as.character(CommuterAdjustedDaytimePopulation200620105yearACSCity$PlaceName)

CommuterAdjustedDaytimePopulation200620105yearACSCity$PlaceName[CommuterAdjustedDaytimePopulation200620105yearACSCity$FipsPlaceCode== "22454"] <- "El Sobrante CDP ContraCosta County"

CommuterAdjustedDaytimePopulation200620105yearACSCity$PlaceName[CommuterAdjustedDaytimePopulation200620105yearACSCity$FipsPlaceCode== "22457
"] <- "El Sobrante CDP Riv County"

# subset cities in California

CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly <- subset(CommuterAdjustedDaytimePopulation200620105yearACSCity, 
                                                                      StateName == "California", select = c(FipsPlaceCode, PlaceName, 
                                                                                                            TotalResidentPopulationEstimate,
                                                                                                            EstimatedDaytimePopulationEstimate,
                                                                                                            DaytimePopulationChangeDueToCommutingEstimate,
                                                                                                            PercentDaytimePopulationChangeDueToCommutingEstimate))

# convert factors to numbers

CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly$TotalResidentPopulationEstimate <- 
  as.numeric(gsub(",","", CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly$TotalResidentPopulationEstimate))
CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly$EstimatedDaytimePopulationEstimate <- 
  as.numeric(gsub(",","", CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly$EstimatedDaytimePopulationEstimate))

CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly$FipsPlaceCode <- 
  as.numeric(as.character(CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly$FipsPlaceCode))

CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly$PercentDaytimePopulationChangeDueToCommutingEstimate <- 
  as.numeric(as.character(CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly$PercentDaytimePopulationChangeDueToCommutingEstimate))

# download the file that has FIPS codes

# download.file("http://www.census.gov/2010census/xls/fips_codes_website.xls", destfile="./CityFipsfile.xls", mode="wb")

# import the downloaded data

filePath <- "./CityFipsfile.xls"
channel <- odbcConnectExcel(filePath)
sqlTables(channel)
fipsData <- sqlFetch(channel, "cqr_universe_fixedwidth_all") # name of Excel spreadsheet
odbcClose(channel)
str(fipsData)

# filter the records that are for california and Los Angeles county

laCountyCities <- subset(fipsData, 
                         `State Abbreviation` == "CA" & `County FIPS Code` == 37)

LaCountyCitiesFips <- merge(laCountyCities, CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly,
                             by.x = "FIPS Entity Code", by.y = "FipsPlaceCode", all.x = TRUE)

LaCountyCitiesFips <- droplevels(LaCountyCitiesFips)
str(LaCountyCitiesFips)

# sort the data

LaCountyCitiesFips <- LaCountyCitiesFips[with(LaCountyCitiesFips, order(PercentDaytimePopulationChangeDueToCommutingEstimate)), ]

TopTenCitiesDayGrowth <- tbl_df(LaCountyCitiesFips) %>% 
  select(City = `GU Name`, `Estimate Residents` = TotalResidentPopulationEstimate, 
         `Estimate Day Population` =  EstimatedDaytimePopulationEstimate, 
         `Day Population Change` = DaytimePopulationChangeDueToCommutingEstimate, 
         `Percent Change` = PercentDaytimePopulationChangeDueToCommutingEstimate) %>%
  arrange(desc(`Percent Change`)) %>%
  top_n(10)

BottomTenCitiesDayGrowth <- tbl_df(LaCountyCitiesFips) %>% 
  select(City = `GU Name`, `Estimate Residents` = TotalResidentPopulationEstimate, 
         `Estimate Day Population` =  EstimatedDaytimePopulationEstimate, 
         `Day Population Change` = DaytimePopulationChangeDueToCommutingEstimate, 
         `Percent Change` = PercentDaytimePopulationChangeDueToCommutingEstimate) %>%
  arrange(desc(`Percent Change`)) %>%
  filter(row_number() >=  89-16 & row_number() <= 89-6)

# merge both sets

comboBottomAndTop <- rbind(TopTenCitiesDayGrowth ,BottomTenCitiesDayGrowth )

```
```{r eval = FALSE, echo=FALSE}

ClusterData  <- CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly

# change the row names

rownames(ClusterData) <- ClusterData$PlaceName

ClusterData$PlaceName <- NULL

ClusterData <- scale(ClusterData)

gc() # do garbage collection

set.seed(1234)

nc <- NbClust(ClusterData, min.nc=2, max.nc=15, method="kmeans")

table(nc$Best.n[1,])

barplot(table(nc$Best.n[1,]),
          xlab="Numer of Clusters", ylab="Number of Criteria",
          main="Number of Clusters Chosen by Criteria")

set.seed(1234)

fit.km <- kmeans(ClusterData, 2, nstart=25)  # two clusters

fit.km$size

aggregate(CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly[-1], by=list(cluster=fit.km$cluster), mean)

(ct.km <- table(CommuterAdjustedDaytimePopulation200620105yearACSCityCAOnly$PlaceName, fit.km$cluster))

write.table(comboRecs, file = "./ct.km.txt",  sep="\t", row.names = FALSE)

```

``` {r echo=FALSE, include=FALSE}
# Import the file of city names

citiesInLACounty <- read.dbf("F:/maps/scagCityBoundaries/city_boundary_scag_2010LACountyOnly.dbf", as.is = FALSE)

str(citiesInLACounty)

# the city of El Monte and Temple City has two spaces so recode it

citiesInLACounty$CITY <- gsub("El  Monte","El Monte", citiesInLACounty$CITY)

citiesInLACounty$CITY <- gsub("Temple  City","Temple City", citiesInLACounty$CITY)

# combine the table 8 records for 2013 and 2009 and match it with the list of cities in the County
# get sets of years 2009 and 2013

CA2013Data   <- subset(comboRecs, 
                        Type == "CA2013")
CA2009Data   <- subset(comboRecs, 
                        Type == "CA2009")


# review the stats for violent crime using the benford analysis

cp <- benford(CA2013Data$`Violent crime`, 2, sign="both") #generates benford object
cp #prints
plot(cp) #plots

head(suspectsTable(cp),10) #prints the digits by decreasing order of discrepancies
#gets observations of the 2 most suspicious groups
suspects <- getSuspects(cp, CA2013Data, how.many=2)

# review the stats for property crime using the benford analysis

cp <- benford(CA2013Data$`Property crime`, 2, sign="both") #generates benford object
cp #prints
plot(cp) #plots

head(suspectsTable(cp),10) #prints the digits by decreasing order of discrepancies
#gets observations of the 2 most suspicious groups
suspects <- getSuspects(cp, CA2013Data, how.many=2)

# review the stats for violent crime using the benford analysis

cp <- benford(CA2009Data$`Violent crime`, 2, sign="both") #generates benford object
cp #prints
plot(cp) #plots

head(suspectsTable(cp),10) #prints the digits by decreasing order of discrepancies
#gets observations of the 2 most suspicious groups
suspects <- getSuspects(cp, CA2009Data, how.many=2)

# review the stats for property crime using the benford analysis

cp <- benford(CA2009Data$`Property crime`, 2, sign="both") #generates benford object
cp #prints
plot(cp) #plots

head(suspectsTable(cp),10) #prints the digits by decreasing order of discrepancies
#gets observations of the 2 most suspicious groups
suspects <- getSuspects(cp, CA2009Data, how.many=2)


comboRecs20092013 <- left_join(CA2013Data, CA2009Data, by = "City")

citiesInLACountyCombo20092013 <- merge(citiesInLACounty, comboRecs20092013, by.x=c("CITY"),
    by.y=c("City"), all.x = TRUE)

names(citiesInLACountyCombo20092013) <- sub("[.]x", "2013", names(citiesInLACountyCombo20092013) )
names(citiesInLACountyCombo20092013) <- sub("[.]y", "2009", names(citiesInLACountyCombo20092013) )

str(citiesInLACountyCombo20092013)

# determine rates of change

citiesInLACountyCombo20092013$IncreasedViolent <- citiesInLACountyCombo20092013$ViolentCrimeRate2013 > citiesInLACountyCombo20092013$ViolentCrimeRate2009

citiesInLACountyCombo20092013$IncreasedProperty <- citiesInLACountyCombo20092013$PropertyCrimeRate2013 > citiesInLACountyCombo20092013$PropertyCrimeRate2009

MeanProp2013ExcOutliers <- mean(citiesInLACountyCombo20092013$PropertyCrimeRate2013, trim = 0.05, na.rm = TRUE)

MeanViolent2013ExcOutliers <- mean(citiesInLACountyCombo20092013$ViolentCrimeRate2013, trim = 0.05, na.rm = TRUE)

MeanProp2013 <- mean(citiesInLACountyCombo20092013$PropertyCrimeRate2013, na.rm = TRUE)

MeanViolent2013 <- mean(citiesInLACountyCombo20092013$ViolentCrimeRate2013, na.rm = TRUE)

MeanProp2009 <- mean(citiesInLACountyCombo20092013$PropertyCrimeRate2009, na.rm = TRUE)

MeanViolent2009 <- mean(citiesInLACountyCombo20092013$ViolentCrimeRate2009, na.rm = TRUE)

medianProp2013 <- median(citiesInLACountyCombo20092013$PropertyCrimeRate2013, na.rm = TRUE)

medianViolent2013 <- median(citiesInLACountyCombo20092013$ViolentCrimeRate2013, na.rm = TRUE)

medianProp2009 <- median(citiesInLACountyCombo20092013$PropertyCrimeRate2009, na.rm = TRUE)

medianViolent2009 <- median(citiesInLACountyCombo20092013$ViolentCrimeRate2009, na.rm = TRUE)

weightedMeanViolent2013 <- weighted.mean(citiesInLACountyCombo20092013$ViolentCrimeRate2013, 
                                         citiesInLACountyCombo20092013$Population2013, na.rm = TRUE)

weightedMeanProp2013 <- weighted.mean(citiesInLACountyCombo20092013$PropertyCrimeRate2013 , 
                                      citiesInLACountyCombo20092013$Population2013, na.rm = TRUE)

weightedMeanViolent2009 <- weighted.mean(citiesInLACountyCombo20092013$ViolentCrimeRate2009, 
                                         citiesInLACountyCombo20092013$Population2009, na.rm = TRUE)

weightedMeanProp2009 <- weighted.mean(citiesInLACountyCombo20092013$PropertyCrimeRate2009 , 
                                      citiesInLACountyCombo20092013$Population2009, na.rm = TRUE)


citiesInLACountyCombo20092013$IncreasedViolent <- citiesInLACountyCombo20092013$ViolentCrimeRate2013 > citiesInLACountyCombo20092013$ViolentCrimeRate2009

citiesInLACountyCombo20092013$IncreasedProperty <- citiesInLACountyCombo20092013$PropertyCrimeRate2013 > citiesInLACountyCombo20092013$PropertyCrimeRate2009

# get the median for all cities in 2013 and 2009

medianProp2013State <- median(CA2013Data$PropertyCrimeRate, na.rm = TRUE)

medianViolent2013State <- median(CA2013Data$ViolentCrimeRate, na.rm = TRUE)

medianProp2009State <- median(CA2009Data$PropertyCrimeRate, na.rm = TRUE)

medianViolent2009State <- median(CA2009Data$ViolentCrimeRate, na.rm = TRUE)

# create a city stats table

Year <-  c (2013,2013,2009,2009,2013,2013,2009,2009,2013,2013,2009,2009)

CityStats <- rbind(MeanProp2013, MeanViolent2013, MeanProp2009, MeanViolent2009, 
                   medianProp2013, medianViolent2013, medianProp2009, medianViolent2009, 
                   weightedMeanViolent2013, weightedMeanProp2013, weightedMeanViolent2009, weightedMeanProp2009)

Measure <-  c ("Mean Property (County)", "Mean Violent (County)", "Mean Property (County)", 
               "Mean Violent (County)", "Median Property (County)", "Median Violent (County)", 
               "Median Property (County)", "Median Violent (County)", "Weighted Mean Violent (County)", 
               "Weighted Mean Property (County)", "Weighted Mean Violent (County)", "Weighted Mean Property (County)")


CityStats <- cbind(CityStats, Year, Measure)

CityStats <- as.data.frame(CityStats)

names(CityStats) <- c( "Value","Year", "City Measure")

# spread the data
CityStats <- spread(CityStats, key= Year, value = Value)

YearState <- c(2013,2013,2009,2009)

StateStats <- rbind(medianProp2013State, medianViolent2013State, medianProp2009State, medianViolent2009State)

MeasureState <- c("Median Property (State)", "Median Violent (State)", "Median Property (State)", "Median Violent (State)")

CityStatsState <- cbind(StateStats, YearState, MeasureState)

CityStatsState <- as.data.frame(CityStatsState)

names(CityStatsState) <- c( "Value","Year", "City Measure")

# spread the data
CityStatsState <- spread(CityStatsState, key= Year, value = Value)

# combine both sets

comboCityStats <- rbind(CityStats, CityStatsState )

# change measures to numbers
comboCityStats$`2009` <- round(as.numeric(comboCityStats$`2009` ),0)
comboCityStats$`2013` <- round(as.numeric(comboCityStats$`2013` ),0)



# Export the data

write.table(citiesInLACountyCombo20092013, file = "./citiesInLACountyCombo20092013.txt",  sep="\t", row.names = FALSE)


```


```{rplot2, fig.width= 5, fig.height = 5, fig.cap= "Property and violent crime rate in 2013 for cities in Los Angles County. Notice  cities with extremly large crime rates", echo=FALSE, fig.lp= 'allCitiesPlot'}

ggplot(citiesInLACountyCombo20092013, aes(ViolentCrimeRate2013, PropertyCrimeRate2013, label=CITY)) + 
  theme_minimal() +
  geom_text(aes(), size= 2, hjust=0, vjust=0,) + 
  geom_point(size =1)  + 
  scale_y_continuous(breaks=c(0,25000,50000,100000,200000,300000,400000,480000),
                     labels = comma_format()) +
    scale_x_continuous(labels = comma_format(),
                       limits=c(0, 24000)) +
  theme(legend.position="bottom") + 
    xlab("Violent Crime Rate in 2013") + 
  ylab("Property Crime Rate in 2013") 
# + ggtitle("2013 property and violent crimes rates\n per  100,000 residents for Cities in L.A. County ") 

```




# Violent and Property crime rates for 2009 and 2013

## Why some cities have extremely high property and violent crime rates?
Some cities in the County have extremly high crime rates, see Figure 1. One reason, among others, is that during the day some cities increase their population due to commuting workers. Crime rates are calculated using city's residents as the denominator, thus cities with small number of residents, but with have large number of people working during the day skew crime rates.   

The crime rate formula per 100,00 residents by city is:    

(Crimes/Population) x 100,0000   

For example, if a city with 50,000 residents that has 10 robberies in a given year, then the robbery rate per 100,000 residents is:    

(50/50,000) = 0.001 x 100,000 = 100 or a rate of 100 robberies per 100,000 residents.   

Table 1 below shows cities in Los Angeles County with extreme changes in population.    


```{r results ='asis', message = FALSE, warning = FALSE, echo = FALSE}

print(xtable(prettyNum(comboBottomAndTop,big.mark=","),
             digits=0, 
             caption = "Top and bottom ten cities of day population change in 
             Los Angeles County. Data from U.S Census Commuter Adjusted Daytime Population: 2006-2010 5-year ACS",  
             label="tblFinalReg", 
             # align = "rl{5cm}r{3cm}r{3cm}r{3cm}r{3cm}"
             ), 
      caption.placement = "bottom", 
      include.rownames=FALSE, 
      # table.placement="t", 
      comment=FALSE)

```


The UCR data for this analysis came from Table 8.  This data has counts of violent and property crimes. Violent crimes include: (1) Murder and nonnegligent manslaughter, (2) Rape (legacy definition), (3) Robbery, and (4) Aggravated assault. The rape definition was changed in 2013, see [here](https://www.fbi.gov/about-us/cjis/ucr/recent-program-updates/new-rape-definition-frequently-asked-questions) for more information. For this analysis, the legacy definition was used. Property crimes include: (1) Burglary, (2) Larceny-theft, (3) Motor vehicle theft, and (4) Arson.    

```{r results ='asis', message = FALSE, warning = FALSE, echo = FALSE}

print(xtable(prettyNum(comboCityStats,big.mark=","),
             digits=0, 
             caption = "Comparison of mean, median, and weighted mean for cities 
             in Los Angeles county for property rates in 2009 and 2013",  
             label="tblCity", 
             # align = "rl{5cm}r{3cm}r{3cm}r{3cm}r{3cm}"
             ), 
      caption.placement = "bottom", 
      include.rownames=FALSE, 
      # table.placement="t", 
      comment=FALSE)

```


\pagebreak



```{rplot4, fig.width = 7, fig.height = 7, fig.cap= "Quadrant graph of property and violent crimes rates in 2013 for Los Angeles County cities, after cities with extremely large rates are excluded. Crime rate medians rather than the averages were used to minimize the influence of cities with extremly high crime rates", echo=FALSE, warning=FALSE, message=FALSE}


ggplot(filter(citiesInLACountyCombo20092013, PropertyCrimeRate2013 <= 10000), 
       aes(ViolentCrimeRate2013, PropertyCrimeRate2013, label=CITY)) +
  theme_minimal() +
  geom_vline(xintercept = medianViolent2013) + 
  geom_hline(yintercept = medianProp2013) + 
  geom_text(aes(hjust=0, vjust=0, colour = factor(IncreasedViolent))) + 
  geom_point(aes(colour = factor(IncreasedViolent)), size = 1.5) + 
  scale_y_continuous(trans=log_trans(), breaks=c(100,500, 1000, 2000, 3000, 4000, 5000),
                     labels = comma_format()) +
  xlab("Violent Crime Rate in 2013") + 
  ylab("Property Crime Rate in 2013 (log scale)") + 
  annotate("text", label = paste("Median violent rate was ", round(medianViolent2013,0), 
                                 "\n in 2013", sep = " "), 
           x = medianViolent2013, y = 300, 
           hjust=0, vjust=1.10, angle = 90, size = 4, colour = "black") +
  annotate("text", label = paste("Median property rate was ", 
                                 prettyNum(round(medianProp2013,0), big.mark=","), 
                                 "\n in 2013 ", sep = " "), 
           x = 900, y = medianProp2013, 
           hjust=0, vjust=1.10, angle = 0,  size = 4, colour = "black") +
  scale_x_continuous(limits=c(0, 1500),
                     labels = comma_format()) +
  scale_colour_manual(name  ="Violent crime rate\n change from 2009", 
                      labels=c("Decreased", 
                               "Increased"), 
                      values = c("TRUE"="#8c510a", "FALSE"="#01665e")) +
  theme(legend.position="bottom")   
 # + ggtitle("2013 rates of crimes per 100,000 residents\n excluding outliers") 


```


```{rplot5, echo=FALSE, warning=FALSE, include=FALSE}

png(filename = "cityCompsViolent.png", width = 10, height = 15, units = "in", res = 1000, type="cairo")


ggplot(citiesInLACountyCombo20092013, aes(colour=factor(IncreasedViolent))) + 
  geom_segment(aes(x=ViolentCrimeRate2009, xend=ViolentCrimeRate2013, 
                   y=CITY, yend=CITY), size=1) + 
  theme_minimal() +
  scale_x_continuous(trans=log_trans(), breaks=c(100,1000,10000,50000),
                     labels = comma_format()) +
  xlab("Violent Crime Rate per 100,000 residents (log scale)") +
  ylab("City") +
  geom_vline(xintercept=medianViolent2013, color = "black") +
  geom_vline(xintercept=medianViolent2009, color = "black") +
  annotate("text", label = paste ("Median violent crime rate for L.A. County cities in 2013 was", 
                                  round(medianViolent2013,0), "crimes per 100,000 residents", 
                                  sep = " "), x = medianViolent2013, y = 1, 
           hjust=0, vjust=1.10, angle = 90, size = 4, colour = "black") + 
  annotate("text", label = paste ("Median violent crime rate for L.A. County cities in 2009 was", 
                                  round(medianViolent2009,0), "crimes per 100,000 residents", 
                                  sep = " "), x = medianViolent2009, y = 1, 
           hjust=0, vjust=1.10, angle = 90, size = 4, colour = "black") + 
  theme(axis.text.x  = element_text(angle=90, vjust=0.5, size=8), 
        axis.text.y  = element_text(angle=0, vjust=0.5, size=6), legend.position = "bottom") + 
  scale_colour_manual(name  ="Violent Crime Rate\n change from 2009", 
                      labels=c("Decreased", 
                               "Increased"), 
                      values = c("TRUE"="#8c510a", "FALSE"="#01665e")) + 
  theme_minimal() +
  theme(legend.position="bottom") 
  # +   ggtitle("Violent crime rate change\n between 2009 and 2013 by city in Los Angeles County")


dev.off()


```


![Median violent crime rate comparison for Los Angeles County cities](C:/Users/e551910/Desktop/AlhambraCityStatsJune18/cityCompsViolent.png)

```{rplot6, echo=FALSE, warning=FALSE, include=FALSE}

png('cityCompsProperty.png', width = 10, height = 15, units = "in", res = 1000, type="cairo")

ggplot(citiesInLACountyCombo20092013, aes(colour=factor(IncreasedProperty))) + 
  geom_segment(aes(x=PropertyCrimeRate2009, xend=PropertyCrimeRate2013, 
                   y=CITY, yend=CITY), size=1) +
  scale_x_continuous(trans=log_trans(), breaks=c(100,1000,10000,100000,500000),
                     labels = comma_format()) +
  theme_minimal() + 
  xlab("Property Crime Rate per 100,000 residents (log scale)") +
  ylab("City") +
  geom_vline(xintercept=medianProp2013, color = "black") +
  geom_vline(xintercept=medianProp2009, color = "black") + 
  annotate("text", label = paste ("Median property crime rate for L.A. County cities in 2013 was", 
                                  prettyNum(round(medianProp2013,0), big.mark=","),
                                  "crimes per 100,000 residents", sep = " "), 
           x = medianProp2013, y = 1, 
           hjust=0, vjust=-0.60, angle = 90, size = 4, colour = "black") + 
  annotate("text", label = 
             paste ("Median property crime rate for L.A. County cities in 2009 was", 
                    prettyNum(round(medianProp2009,0), big.mark=","),
                    "crimes per 100,000 residents", sep = " "), 
           x = medianProp2009, y = 1, 
           hjust=0, vjust=1.40, angle = 90, size = 4, colour = "black") +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5, size=8), 
        axis.text.y  = element_text(angle=0, vjust=0.5, size=8), legend.position = "bottom") + 
  scale_colour_manual(name  ="Property rate crime\n change from 2009", 
                      labels=c("Decreased", 
                               "Increased"), 
                      values = c("TRUE"="#8c510a", "FALSE"="#01665e")) + 
  theme(legend.position="bottom") + 
  theme(axis.text.x  = element_text(angle=00, vjust=0.5, size=8), 
        axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) 
# +  ggtitle("Property crime rate change\n between 2009 and 2013 by city in Los Angeles County")
dev.off()


# write.table(citiesInLACountyCombo20092013, file = "./comboRecs20092013.txt",  sep="\t", row.names = FALSE)

```
![Median property crime rate comparison for Los Angeles County cities](C:/Users/e551910/Desktop/AlhambraCityStatsJune18/cityCompsProperty.png)


![Los Angeles County cities violent crime rate changes between 2009 and 2013](C:/Users/e551910/Desktop/AlhambraCityStatsJune18/CitiesCrimeRateChangeViolent.tif)

![Los Angeles County cities property crime rate changes between 2009 and 2013](C:/Users/e551910/Desktop/AlhambraCityStatsJune18/CitiesCrimeRateChangeProperty.tif)


![Los Angeles County cities violent crime rate percentage changes between 2009 and 2013](C:/Users/e551910/Desktop/AlhambraCityStatsJune18/CitiesCrimeRateChangeViolentPercent.tif)  

![Los Angeles County cities property crime rate percentage changes between 2009 and 2013](C:/Users/e551910/Desktop/AlhambraCityStatsJune18/CitiesCrimeRateChangePropertyPercent.tif)   



*****

\newpage


# Analysis of the Los Angeles County Jail Profile

For this analysis data from The Board of State and Community Corrections. Jail Survey Data @CaJailProfileSurvey available is between January 2002 and September 2014. These data can be accessed [here](http://www.bscc.ca.gov/s_fsojailprofilesurvey.php). It is important to note that Prop 47 passed in November 2014, and any effects it had in jail population counts can't be analyzed at this time.     

The Jail survey data has following variables : (1) Jurisdiction, (2) Year, (3) Month, (4) (ADP totals) Unsentenced males, (5) (ADP totals) Unsentenced females, (6) (ADP totals) Sentenced males, (7) (ADP totals) Sentenced females, (8) (ADP totals) Jurisdiction, (9) (Avg number of felony inmates) Unsentenced, (10) (Avg number of felony inmates) Sentenced, (11) (Avg number of felony inmates) Total, (12) (Avg number of misdemeanor inmates) Unsentenced, (13) (Avg number of misdemeanor inmates) Sentenced, (14) (Avg number of misdemeanor inmates) Total, (15) Highest one-day population for this month occurred on:, (16) The highest count was:, (17) ADP of maximum security inmates, (18) ADP of medium security inmates, (19) ADP of minimum security inmates, (20) Mental health cases opened last day of the month, (21) New mental health cases opened during this month, (22) Inmates, last day of the month, receiving psych medication, (23) Inmates assigned to mental health beds last day of month, (24) Inmates that were seen at inmate sick call this month, (25) Physician/practitioner occurrences during this month, (26) Off-site medical appointments during this month, (27) Dental encounters during this month, (28) Inmates assigned to medical beds last day of the month, (29) Avg # of inmates not assigned to housing, (30) Avg # of your inmates in contract beds in other jurisdictions, (31) Avg # of federal inmates housed in your system on contract, (32) Avg # of state inmates housed in your system on contract, (33) Avg # of inmates from other Co. in your system on contract, (34) Avg # of inmates sent. and awaiting transport to state prison, (35) Avg # of inmates in hospital(s) outside of your jail facilities, (36) Total # of persons booked this month, (37) Total # of pretrial released due to lack of housing capacity, (38) Total # of sent. released due to lack of housing capacity, and (39) Total # of juveniles in custody this month (per 707 W&I code).    


Structural change analyses were employed to determine trends on the following variables:    


1. (16) The highest count was: 
2. (17) ADP of maximum security inmates
3. (22) Inmates, last day of the month, receiving psych medication
4. (23) Inmates assigned to mental health beds last day of month
5. (36) Total # of persons booked this month
6. (38) Total # of sent. released due to lack of housing capacity    


Based on the structural change analysis for the variable 'Highest counts by month', before AB 109 began and a few months later there was a downward trend. This trend began on December 2009 (95% Confidence Interval (C.I.) October 2009, January 2010). On March 2012 (95% C.I. February, May 2012) a new trend began with an upward slope see Figure 9.    

For the variable variable 'ADP (average daily population) of maximum security inmates', there are two trends, the last trend began in October 2003. This trend has a downward slope that AB109 seems to have no effect on it.    

For the variable variable 'Inmates, last day of the month, receiving psych medication', there are three trends. The current trend began in November 2011 (95% C.I. October 2011, April 2012).  This trend has an increasing slope.  The trend before that was more or less flat and began in September 2006 (95% C.I. April, October 2006).

For the variable 'Inmates assigned to mental health beds last day of month', the current trend began in May 2012 (95% C.I. March, June 2012). This trend has a downward slope.  The prior trend began in March 2008 (95% C.I. January, May 2008). This trend was, more or less, flat. 

For variable 'Persons booked this month', the current trend began on September 2010 (C.I. January 2010, January 2011). This trend has a downward slope.  The trend before this began in October 2008 (95% C.I. August 2008, January 2009). This trend has a similar slope but with higher monthly counts. 

For variable 'Sentence released due to lack of housing capacity counts' the current trend began in December 2010 (95% C.I. November, February 2011). This trend has a downward slope. The trend before that began in November 2008 (95% C.I. November 2007, May 2009).  This trend has a downward slope but with higher counts.   

In conclusion and only for the variables analyzed, the number of highest count by month and inmates receiving psych medication increased after AB 109 started. However the other variables analyzed had decreasing trends or the trends did not changed after AB 109 began.   


\clearpage


```{r JailStructChange, eval =TRUE, echo=FALSE, include=FALSE}

# import jail counts

filePath <- "./JailProfileLaCounty.xlsx"
channel <- odbcConnectExcel2007(filePath)
sqlTables(channel)
jailMonthPopLACounty <- sqlFetch(channel, "data") # name of Excel spreadsheet
odbcClose(channel)
str(jailMonthPopLACounty)

dateStartAb109 <- as.Date("2010-10-01")

# remove name puctuation and format names

names(jailMonthPopLACounty) <- gsub("[[:punct:]]", "", names(jailMonthPopLACounty)) 

names(jailMonthPopLACounty)<- gsub("(\\w)(\\w*)", "\\U\\1\\L\\2", names(jailMonthPopLACounty), perl = TRUE)

names(jailMonthPopLACounty) <- gsub(" ", "", names(jailMonthPopLACounty)) 

# create a sequence of months to add the to data

jailMonthPopLACounty$YearMonth <- c(seq(as.Date("2002/01/1"), 
                                        by = "month", 
                                        length.out = nrow(jailMonthPopLACounty)))

# crate a time series count of highest county by month

highMonthCountMonth <- subset(jailMonthPopLACounty, 
                              select = c(YearMonth, TheHighestCountWas))

highMonthCount <- subset(jailMonthPopLACounty, select = c(TheHighestCountWas))

# make the count a time series object
tsHighMonthCount <- ts(as.vector(highMonthCount), 
                       start=c(2002,1), end=c(2014,9), frequency = 12)

# complete structural change analysis on this variable

breakTrendData <- tsHighMonthCount

plot(breakTrendData)
bpData <- breakpoints(breakTrendData ~ 1)
summary(bpData)

plot(bpData)
breakpoints(bpData)

## confidence interval
(ci.highJailCount <- confint(bpData))
lines(ci.highJailCount)

# list the breakpoints for this count

tsHighMonthCountBreakPoints <- as.data.frame(bpData$breakpoints)

names(tsHighMonthCountBreakPoints) <- "BreakPoints"

# create a sequence of numbers on data with counts and
# breakpoints

highMonthCountMonth$seqNumb <- as.numeric(seq(1, NROW(highMonthCountMonth), by = 1 ))

tsHighMonthCountBreakPoints$seqGrp <- as.numeric(seq(1, NROW(tsHighMonthCountBreakPoints), by = 1 ))

highMonthCountMonth <- merge(highMonthCountMonth, tsHighMonthCountBreakPoints, 
                             by.x = "seqNumb", by.y = "BreakPoints", all.x=TRUE)

# replace nas with zeroes

highMonthCountMonth$seqGrp[is.na(highMonthCountMonth$seqGrp)] <- 0

# create groups of breakpoints
startCount <- 0

for (c in 1:nrow(highMonthCountMonth)) {
  startCount <- startCount + highMonthCountMonth[c, "seqGrp"] # create cumm sum
  highMonthCountMonth[c, "CummSum"] <- startCount}

```


```{r echo=FALSE, include=FALSE}
# work with Average Daily Population (ADP)\n Maximum Security Inmates

AdpOfMaximumSecurityInmatesMonth <- subset(jailMonthPopLACounty, 
                                           select = c(YearMonth, AdpOfMaximumSecurityInmates))

AdpOfMaximumSecurityInmates <- subset(jailMonthPopLACounty, select = c(AdpOfMaximumSecurityInmates))

# make the count a time series object
tsAdpOfMaximumSecurityInmates <- ts(as.vector(AdpOfMaximumSecurityInmates), 
                                    start=c(2002,1), end=c(2014,9), frequency = 12)

# complete structural change analysis on this variable

breakTrendData <- tsAdpOfMaximumSecurityInmates

plot(breakTrendData)
bpData <- breakpoints(breakTrendData ~ 1)
summary(bpData)

plot(bpData)
breakpoints(bpData)

tsAdpOfMaximumSecurityInmatesBreakPoints <- as.data.frame(bpData$breakpoints)

names(tsAdpOfMaximumSecurityInmatesBreakPoints) <- "BreakPoints"

# create a sequence of numbers on data with counts and
# breakpoints

AdpOfMaximumSecurityInmatesMonth$seqNumb <- as.numeric(seq(1, NROW(AdpOfMaximumSecurityInmatesMonth), by = 1 ))

tsAdpOfMaximumSecurityInmatesBreakPoints$seqGrp <- as.numeric(seq(1, NROW(tsAdpOfMaximumSecurityInmatesBreakPoints), by = 1 ))

AdpOfMaximumSecurityInmatesMonth <- merge(AdpOfMaximumSecurityInmatesMonth, tsAdpOfMaximumSecurityInmatesBreakPoints, 
                                          by.x = "seqNumb", by.y = "BreakPoints", all.x=TRUE)

# replace nas with zeroes

AdpOfMaximumSecurityInmatesMonth$seqGrp[is.na(AdpOfMaximumSecurityInmatesMonth$seqGrp)] <- 0

# create groups of breakpoints
startCount <- 0

for (c in 1:nrow(AdpOfMaximumSecurityInmatesMonth)) {
  startCount <- startCount + AdpOfMaximumSecurityInmatesMonth[c, "seqGrp"] # create cumm sum
  AdpOfMaximumSecurityInmatesMonth[c, "CummSum"] <- startCount}

```


```{r  echo=FALSE, warning=FALSE, include=FALSE}

# Inmates Last Day Of The Month Receiving PsychMedication


InmatesLastDayOfTheMonthReceivingPsychMedicationMonth <- subset(jailMonthPopLACounty, 
                                                                select = c(YearMonth, InmatesLastDayOfTheMonthReceivingPsychMedication))

InmatesLastDayOfTheMonthReceivingPsychMedication <- subset(jailMonthPopLACounty, 
                                                           select = c(InmatesLastDayOfTheMonthReceivingPsychMedication))

# make the count a time series object
breakTrendData <- ts(as.vector(InmatesLastDayOfTheMonthReceivingPsychMedication), 
                     start=c(2002,1), end=c(2014,9), frequency = 12)

# complete structural change analysis on this variable

plot(breakTrendData)
bpData <- breakpoints(breakTrendData ~ 1)
summary(bpData)

plot(bpData)
breakpoints(bpData)

## confidence interval
(ci.Breaks <- confint(bpData))
lines(ci.Breaks)

# list the breakpoints for this count

tsBreakPoints <- as.data.frame(bpData$breakpoints)

names(tsBreakPoints) <- "BreakPoints"

# create a sequence of numbers on data with counts and
# breakpoints

InmatesLastDayOfTheMonthReceivingPsychMedicationMonth$seqNumb <- 
  as.numeric(seq(1, NROW(InmatesLastDayOfTheMonthReceivingPsychMedicationMonth), by = 1 ))

tsBreakPoints$seqGrp <- as.numeric(seq(1, NROW(tsBreakPoints), by = 1 ))

InmatesLastDayOfTheMonthReceivingPsychMedicationMonth <- 
  merge(InmatesLastDayOfTheMonthReceivingPsychMedicationMonth, tsBreakPoints, 
        by.x = "seqNumb", by.y = "BreakPoints", all.x=TRUE)

# replace nas with zeroes

InmatesLastDayOfTheMonthReceivingPsychMedicationMonth$seqGrp[is.na(InmatesLastDayOfTheMonthReceivingPsychMedicationMonth$seqGrp)] <- 0

# create groups of breakpoints
startCount <- 0

for (c in 1:nrow(InmatesLastDayOfTheMonthReceivingPsychMedicationMonth)) {
  startCount <- startCount + InmatesLastDayOfTheMonthReceivingPsychMedicationMonth[c, "seqGrp"] # create cumm sum
  InmatesLastDayOfTheMonthReceivingPsychMedicationMonth[c, "CummSum"] <- startCount}

```


```{r  echo=FALSE, warning=FALSE, include=FALSE}

# Inmates Assigned To Mental Health Beds Last Day Of Month

InmatesAssignedToMentalHealthBedsLastDayOfMoMonth <- subset(jailMonthPopLACounty, 
                                                            select = c(YearMonth, InmatesAssignedToMentalHealthBedsLastDayOfMonth))

InmatesAssignedToMentalHealthBedsLastDayOfMonth <- subset(jailMonthPopLACounty, 
                                                          select = c(InmatesAssignedToMentalHealthBedsLastDayOfMonth))

# make the count a time series object
breakTrendData <- ts(as.vector(InmatesAssignedToMentalHealthBedsLastDayOfMonth), 
                     start=c(2002,1), end=c(2014,9), frequency = 12)

# complete structural change analysis on this variable

plot(breakTrendData)
bpData <- breakpoints(breakTrendData ~ 1)
summary(bpData)

plot(bpData)
breakpoints(bpData)

## confidence interval
(ci.Breaks <- confint(bpData))
lines(ci.Breaks)

# list the breakpoints for this count

tsBreakPoints <- as.data.frame(bpData$breakpoints)

names(tsBreakPoints) <- "BreakPoints"

# create a sequence of numbers on data with counts and
# breakpoints

InmatesAssignedToMentalHealthBedsLastDayOfMoMonth$seqNumb <- 
  as.numeric(seq(1, NROW(InmatesAssignedToMentalHealthBedsLastDayOfMoMonth), by = 1 ))

tsBreakPoints$seqGrp <- as.numeric(seq(1, NROW(tsBreakPoints), by = 1 ))

InmatesAssignedToMentalHealthBedsLastDayOfMoMonth <- merge(InmatesAssignedToMentalHealthBedsLastDayOfMoMonth, tsBreakPoints, 
                                                           by.x = "seqNumb", by.y = "BreakPoints", all.x=TRUE)

# replace nas with zeroes

InmatesAssignedToMentalHealthBedsLastDayOfMoMonth$seqGrp[is.na(InmatesAssignedToMentalHealthBedsLastDayOfMoMonth$seqGrp)] <- 0

# create groups of breakpoints
startCount <- 0

for (c in 1:nrow(InmatesAssignedToMentalHealthBedsLastDayOfMoMonth)) {
  startCount <- startCount + InmatesAssignedToMentalHealthBedsLastDayOfMoMonth[c, "seqGrp"] # create cumm sum
  InmatesAssignedToMentalHealthBedsLastDayOfMoMonth[c, "CummSum"] <- startCount}

```


```{r  echo=FALSE, warning=FALSE, include=FALSE}

# Persons Booked This Month

TotalOfPersonsBookedThisMoMonth <- subset(jailMonthPopLACounty, 
                                          select = c(YearMonth, TotalOfPersonsBookedThisMonth))

TotalOfPersonsBookedThisMonth <- subset(jailMonthPopLACounty, 
                                        select = c(TotalOfPersonsBookedThisMonth))

# make the count a time series object
breakTrendData <- ts(as.vector(TotalOfPersonsBookedThisMonth), 
                     start=c(2002,1), end=c(2014,9), frequency = 12)

# complete structural change analysis on this variable

plot(breakTrendData)
bpData <- breakpoints(breakTrendData ~ 1)
summary(bpData)

plot(bpData)
breakpoints(bpData)

## confidence interval
(ci.Breaks <- confint(bpData))
lines(ci.Breaks)

# list the breakpoints for this count

tsBreakPoints <- as.data.frame(bpData$breakpoints)

names(tsBreakPoints) <- "BreakPoints"

# create a sequence of numbers on data with counts and
# breakpoints

TotalOfPersonsBookedThisMoMonth$seqNumb <- as.numeric(seq(1, NROW(TotalOfPersonsBookedThisMoMonth), by = 1 ))

tsBreakPoints$seqGrp <- as.numeric(seq(1, NROW(tsBreakPoints), by = 1 ))

TotalOfPersonsBookedThisMoMonth <- merge(TotalOfPersonsBookedThisMoMonth, tsBreakPoints, 
                                         by.x = "seqNumb", by.y = "BreakPoints", all.x=TRUE)

# replace nas with zeroes

TotalOfPersonsBookedThisMoMonth$seqGrp[is.na(TotalOfPersonsBookedThisMoMonth$seqGrp)] <- 0

# create groups of breakpoints
startCount <- 0

for (c in 1:nrow(TotalOfPersonsBookedThisMoMonth)) {
  startCount <- startCount + TotalOfPersonsBookedThisMoMonth[c, "seqGrp"] # create cumm sum
  TotalOfPersonsBookedThisMoMonth[c, "CummSum"] <- startCount}

```


```{r  echo=FALSE, warning=FALSE, include=FALSE}

# Total Of Sent Released Due To Lack Of Housing Capacity

TotalOfSentReleasedDueToLackOfHousingCapacityMonth <- subset(jailMonthPopLACounty, 
                                                             select = c(YearMonth, TotalOfSentReleasedDueToLackOfHousingCapacity))

TotalOfSentReleasedDueToLackOfHousingCapacity <- subset(jailMonthPopLACounty, 
                                                        select = c(TotalOfSentReleasedDueToLackOfHousingCapacity))

# make the count a time series object
breakTrendData <- ts(as.vector(TotalOfSentReleasedDueToLackOfHousingCapacity), 
                     start=c(2002,1), end=c(2014,9), frequency = 12)

# complete structural change analysis on this variable

plot(breakTrendData)
bpData <- breakpoints(breakTrendData ~ 1)
summary(bpData)

plot(bpData)
breakpoints(bpData)

## confidence interval
(ci.Breaks <- confint(bpData))
lines(ci.Breaks)

# list the breakpoints for this count

tsBreakPoints <- as.data.frame(bpData$breakpoints)

names(tsBreakPoints) <- "BreakPoints"

# create a sequence of numbers on data with counts and
# breakpoints

TotalOfSentReleasedDueToLackOfHousingCapacityMonth$seqNumb <- as.numeric(seq(1, NROW(TotalOfSentReleasedDueToLackOfHousingCapacityMonth), by = 1 ))

tsBreakPoints$seqGrp <- as.numeric(seq(1, NROW(tsBreakPoints), by = 1 ))

TotalOfSentReleasedDueToLackOfHousingCapacityMonth <- merge(TotalOfSentReleasedDueToLackOfHousingCapacityMonth, tsBreakPoints, 
                                                            by.x = "seqNumb", by.y = "BreakPoints", all.x=TRUE)

# replace nas with zeroes

TotalOfSentReleasedDueToLackOfHousingCapacityMonth$seqGrp[is.na(TotalOfSentReleasedDueToLackOfHousingCapacityMonth$seqGrp)] <- 0

# create groups of breakpoints
startCount <- 0

for (c in 1:nrow(TotalOfSentReleasedDueToLackOfHousingCapacityMonth)) {
  startCount <- startCount + TotalOfSentReleasedDueToLackOfHousingCapacityMonth[c, "seqGrp"] # create cumm sum
  TotalOfSentReleasedDueToLackOfHousingCapacityMonth[c, "CummSum"] <- startCount}


# add a variable to identify each variables' structural change

highMonthCountMonth$Type <- "Highest count"
AdpOfMaximumSecurityInmatesMonth$Type <- "ADP (average daily population) maximum  mecurity inmates"
InmatesLastDayOfTheMonthReceivingPsychMedicationMonth$Type <- "Inmates receiving psych medication last day of month"
InmatesAssignedToMentalHealthBedsLastDayOfMoMonth$Type <- "Inmates assigned to mental health beds last day of month"
TotalOfPersonsBookedThisMoMonth$Type <- "Persons booked this month"
TotalOfSentReleasedDueToLackOfHousingCapacityMonth$Type <- "Sentenced released due to lack of housing capacity"

# rename the sets
names(highMonthCountMonth) <- c("seqNumb", "YearMonth", "count", "seqGrp", "CummSum", "Type" )
names(AdpOfMaximumSecurityInmatesMonth) <- c("seqNumb", "YearMonth", "count", "seqGrp", "CummSum", "Type" )
names(InmatesLastDayOfTheMonthReceivingPsychMedicationMonth) <- c("seqNumb", "YearMonth", "count", "seqGrp", "CummSum", "Type" )
names(InmatesAssignedToMentalHealthBedsLastDayOfMoMonth) <- c("seqNumb", "YearMonth", "count", "seqGrp", "CummSum", "Type" )
names(TotalOfPersonsBookedThisMoMonth) <- c("seqNumb", "YearMonth", "count", "seqGrp", "CummSum", "Type" )
names(TotalOfSentReleasedDueToLackOfHousingCapacityMonth) <- c("seqNumb", "YearMonth", "count", "seqGrp", "CummSum", "Type" )

# combine the sets
comboJailProfSets <- rbind(highMonthCountMonth, AdpOfMaximumSecurityInmatesMonth, 
                           InmatesLastDayOfTheMonthReceivingPsychMedicationMonth, 
                           InmatesAssignedToMentalHealthBedsLastDayOfMoMonth, 
                           TotalOfPersonsBookedThisMoMonth, 
                           TotalOfSentReleasedDueToLackOfHousingCapacityMonth)

# get a copy of the set for the piecewise regression

comboJailProfSetsPiecewise <- comboJailProfSets


```


```{rplot13, fig.width= 10, fig.height = 15, echo=FALSE, fig.cap= "Selected Jail Survey variables for Los Angeles County from January 2002 to December 2014", warning=FALSE}

# order levels
comboJailProfSets$Type <- factor(comboJailProfSets$Type, 
                                 levels = c("Highest count",
                                            "ADP (average daily population) maximum  mecurity inmates", 
                                            "Inmates receiving psych medication last day of month",
                                            "Inmates assigned to mental health beds last day of month",
                                            "Persons booked this month",
                                            "Sentenced released due to lack of housing capacity"))

end <- max(comboJailProfSets$YearMonth)


# create a label on one variable only

ann_text <- data.frame(YearMonth = dateStartAb109, count = 500, lab = "Text",
                       Type = factor("Highest count",
                                     levels = c("Highest count",
                                                "ADP (average daily population) maximum  mecurity inmates", 
                                                "Inmates receiving psych medication last day of month", 
                                                "Inmates assigned to mental health beds last day of month",
                                                "Persons booked this month","Sentenced released due to lack of housing capacity")))


ggplot(data = comboJailProfSets, aes(x = YearMonth, y = count ))  +
  geom_line(stat = "identity", size = 1) + geom_point() +  
  facet_wrap(~ Type, ncol = 1,scales = "free_y" ) + 
  scale_x_date("Month and Year", 
               limits = c(as.Date("2002-2-1"), end),
               labels = date_format("%b-%y"), 
               breaks = date_breaks("6 month")) +
  stat_smooth(method="lm", data = comboJailProfSetsPiecewise , size = 1, 
              alpha = .5, se = TRUE, fill = "lightblue",
              linetype = 'twodash', aes(color = factor(CummSum))) +
  guides(colour=FALSE) +
  theme_bw() + 
  theme( #panel.grid.major = element_blank(),
    #panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    panel.border = element_rect(colour = "black")) +
  scale_y_continuous("Count", limits=c(0,max(comboJailProfSets$count)),
                     labels = comma) +
  geom_vline(xintercept = as.numeric(dateStartAb109), linetype=4, size = 1, 
             color="blue") +
  # annotate("text", label = "Start of AB109", 
  #            x = dateStartAb109, y = 20, 
  #            hjust=0, vjust=1.50, angle = 90, size = 4, colour = "blue") +
  geom_text(data = ann_text,label = "Start of AB109",hjust=0, vjust=1.50, angle = 90, size = 4, colour = "blue") +
  theme(axis.title.x = element_text(size = 16, angle = 00)) +
  theme(axis.title.y = element_text(size = 16, angle = 90)) +
  theme(axis.text.x = element_text(colour = "black", 
                                   size = 16, 
                                   angle = 90, 
                                   vjust = .5)) +
  theme(axis.text.y = element_text(colour = "black", 
                                   size = 16, 
                                   angle = 00))

#get the time
endTime <- Sys.time()

```

\clearpage


The analysis was completed on `r format(Sys.time(), "%a %b %d %X %Y")
` in `r round(difftime(endTime, startTime , units = c( "secs")),0)` seconds.  


# References

---
references:


- id: FBITable8
  title: Table 8
  author:
  - family: 
    given: 
  container-title: Uniform Crime Reporting (UCR) Program
  URL: 'https://www.fbi.gov/about-us/cjis/ucr/ucr'
  publisher: Federal Bureau of Investigation
  type: article-journal
  issued:
    year: 2009
        
- id: PPICRealigmentTrends
  title: Realignment, Incarceration, and Crime Trends in California
  author:
  - family: Lofstrom, Magnus, and Raphael, Steven 
    given:   
  container-title: Realignment, Incarceration, and Crime Trends in California
  URL: 'http://www.ppic.org/main/publication_quick.asp?i=1151'

  publisher: Public Policy Institute of California
  type: article-journal
  issued:
    year: 2015
    month: 5
    
- id: AB109
  title: Assembly Bill No. 109
  author:
  - family: 
    given: 
  container-title: Assembly Bill No. 109
  URL: 'http://leginfo.legislature.ca.gov/faces/billNavClient.xhtml?bill_id=201120120AB109'
  publisher: California Secretary of State
  type: article-journal
  issued:
    year: 2011
    month: 4
    
- id: CaJailProfileSurvey
  title: Jail Profile Survey
  author:
  - family: 
    given: 
  container-title: Jail Profile Survey
  URL: 'http://www.bscc.ca.gov/s_fsojailprofilesurvey.php'
  publisher: Board of State and Community Corrections
  type: article-journal
  issued:
    year: 2015
    month: 7
...


